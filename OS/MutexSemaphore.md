# 뮤텍스와 세마포어

동시성 프로그래밍의 가장 큰 숙제는 '공유 자원 관리'이다.  
프로세스 간 메시지를 전송하거나, 공유메모리를 통해 공유된 자원에 여러 개의 프로세스가 동시에 접근하면 Critical Section 문제가 발생할 수 있다. 이를 해결하기 위해 데이터를 한 번에 하나의 프로세스만 접근할 수 있도록 제한을 두는 동기화 방식을 취해야 한다. 동기화 도구에는 대표적으로 뮤텍스(Mutex)와 세마포어(Semaphore)가 있다. 이들은 모두 공유된 자원의 데이터를 여러 스레드/프로세스가 접근하는 것을 막는 역할을 한다.
공유자원을 안전하게 관리하기 위해서는 상호 배제(Mutual Extension)를 달성하는 기법이 필요하다.  
뮤텍스와 세마포어는 이를 위해 고안된 기법으로 서로 다른 방식으로 상호 배제를 달성한다.  

*Critical Section*  
: 임계 영역. 여러 프로세스가 데이터를 공유하며 수행될 때, 각 프로세스에서 공유 데이터를 접근하는 프로그램 코드 블록

<br>

### 뮤텍스 (Mutex)
뮤텍스는 화장실이 하나밖에 없는 식당과 비슷하다. 화장실을 가기 위해서는 카운터에서 열쇠를 받아 가야 한다. 화장실을 가려고 하는데 카운터에 키가 있으면 화장실에 사람이 없다는 뜻이고, 그 열쇠를 통해 화장실에 들어갈 수 있다.

화장실에서 행복한 시간을 보내고 있는데 다른 테이블에 있는 어떤 사람이 화장실에 가고 싶어졌다. 이 사람은 아무리 급해도 열쇠가 없기 때문에 화장실에 들어갈 수 없다. 즉 이 사람은 화장실에서 사람이 나올 때까지 카운터에서 기다려야 한다.

곧이어 옆 테이블에 있는 다른 사람도 화장실에 가고 싶어졌다면, 이 사람 또한 화장실에 들어가기 위해서는 카운터에서 대기해야 한다.

이제 화장실에서 나와 카운터에 키를 돌려 놓았다. 기다리던 사람들 중 맨 앞에 있던 사람은 키를 받을 수 있고 이를 이용해 화장실에 갈 수 있다.

이것이 뮤텍스가 동작하는 방식이다. 화장실을 이용하는 사람은 **프로세스** 혹은 **스레드**이며, 화장실은 **공유자원**, 화장실 키는 **공유자원에 접근하기 위해 필요한 어떤 오브젝트**이다.  
즉, 뮤텍스는 Key에 해당하는 어떤 오브젝트가 있고 이 오브젝트를 소유한 스레드, 프로세스만이 공유자원에 접근할 수 있다.  
다중 프로세스들의 공유 리소스에 대한 접근을 조율하기 위해 동기화(Synchronization) 또는 락(Lock)을 사용함으로써 뮤텍스 객체를 두 스레드가 동시에 사용할 수 없다.

<br>

### 세마포어 (Semaphore)
세마포어는 손님이 화장실을 좀 더 쉽게 이용할 수 있는 레스토랑이다. 세마포어를 이용하는 레스토랑의 화장실에는 여러 개의 칸이 있다. 그리고 화장실 입구에는 현재 화장실의 빈 칸 개수를 보여주는 전광판이 있다.

만약 화장실에 가고 싶다면 빈 칸의 개수를 확인하고, 빈 칸이 1개 이상이라면 (빈칸의 개수-1)한 다음에 화장실로 입장해야 한다. 그리고 나올 땐 빈 칸의 개수를 하나 더해준다.

모든 칸에 사람이 있다면 빈 칸의 개수는 0이 되고, 이때 화장실에 들어가고자 하는 사람이 있다면 빈 칸의 개수가 1로 바뀔 때까지 기다려야 한다.

사람들은 나오면서 빈 칸의 개수를 1씩 더한다. 그리고 기다리던 사람은 이 숫자에서 다시 1을 뺀 다음 화장실로 들어간다.

이처럼 세마포어는 공통으로 관리하는 하나의 값을 이용해 상호배제를 달성한다.

세마포어도 화장실이 **공유자원**이며, 사람들이 **스레드/프로세스**이다. 그리고 화장실 빈칸의 개수는 **현재 공유자원에 접근할 수 있는 스레드/프로세스의 개수**이다.

일반적으로 비교적 긴 시간을 확보하는 리소스에 대해 사용하게 된다.

<br>

### 정리
- 뮤텍스  
  한 스레드/프로세스에 의해 소유될 수 있는 Key를 기반으로 한 상호배제기법 (동기화 대상이 하나)
- 세마포어  
  Signaling mechanism. 현재 공유자원에 접근할 수 있는 스레드/프로세스의 수를 나타내는 값을 두어 상호배제를 달성하는 기법 (동기화 대상이 하나 이상)

**차이점**
- 뮤텍스는 동기화 대상이 오직 1개일 때 사용하며, 세마포어는 동기화 대상이 1개 이상일 때 사용한다.
- 뮤텍스는 자원을 소유할 수 있고 책임을 가지는 반면, 세마포어는 자원 소유가 불가하다.
- 뮤텍스는 상태가 0, 1 뿐이므로 Lock을 가질 수 있고, 소유하고 있는 스레드만이 이 뮤텍스를 해제할 수 있다. 반면 세마포어는 세마포어를 소유하지 않는 스레드가 세마포어를 해제할 수 있다.
- 세마포어는 시스템 범위에 걸쳐 있고, 파일 시스템 상의 파일로 존재한다. 반면, 뮤텍스는 프로세스의 범위를 가지며 프로세스 종료될 때 자동으로 Clean up 된다.   

두 기법 모두 완벽한 기법은 아니다. 이 기법들을 쓰더라도 **데이터 무결성을 보장할 수 없고**, **데드락이 발생**할 수도 있다. 하지만 상호배제를 위한 기본적인 기법이며 여기에 좀 더 복잡한 매커니즘을 적용해 우아하게 동작하는 프로그램을 만들 수 있다.


<br>

#### 참고
[뮤텍스와 세마포어의 차이-티스토리](https://worthpreading.tistory.com/90)  
[뮤텍스와 세마포어-티스토리](https://heeonii.tistory.com/14)